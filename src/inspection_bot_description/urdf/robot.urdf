<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="traktor_custom_size">

  <!-- ======================================================================== -->
  <!-- 1. 车身 (Base Link) -->
  <!-- 尺寸: 长0.806, 宽0.607, 高0.323 -->
  <!-- ======================================================================== -->
  <link name="base_link">
    <visual>
      <!-- 视觉中心稍微抬高一点，让轮子刚好在底部 -->
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.806 0.607 0.323"/>
      </geometry>
      <material name="white_paint">
        <color rgba="1.0 1.0 1.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.806 0.607 0.323"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="30"/>
      <!-- 简单的长方体惯性矩阵估算 -->
      <inertia ixx="1.18" ixy="0" ixz="0" iyy="1.88" iyz="0" izz="2.54"/>
    </inertial>
  </link>

  <!-- ======================================================================== -->
  <!-- 2. 前轮转向机构 (Steering Links) - 也就是"转向节" -->
  <!-- 为了美观，把这些关节做得很小，隐藏在车身下面 -->
  <!-- ======================================================================== -->

  <!-- 左前转向节 -->
  <link name="left_steering_link">
    <inertial><mass value="0.5"/><origin xyz="0 0 0"/><inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/></inertial>
    <visual>
      <geometry><cylinder radius="0.02" length="0.05"/></geometry>
      <material name="black"/>
    </visual>
  </link>

  <joint name="left_steering_joint" type="revolute">
    <parent link="base_link"/>
    <child link="left_steering_link"/>
    <!-- 位置计算: X轴靠前0.25m, Y轴靠左0.24m (确保轮子在0.3035以内), Z轴在车底 -->
    <!-- 车高0.323，半高0.1615。轮子半径0.076。让轮子着地，轴心应该在 -0.1615 + 0.076 附近 -->
    <!-- 这里稍微调整让车身离地有点间隙 -->
    <origin xyz="0.25 0.24 -0.16" rpy="0 0 0"/>
    <axis xyz="0 0 1"/> <!-- 绕Z轴旋转进行转向 -->
    <limit lower="-0.6" upper="0.6" effort="100" velocity="10"/>
  </joint>

  <!-- 右前转向节 -->
  <link name="right_steering_link">
    <inertial><mass value="0.5"/><origin xyz="0 0 0"/><inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/></inertial>
    <visual>
      <geometry><cylinder radius="0.02" length="0.05"/></geometry>
      <material name="black"/>
    </visual>
  </link>

  <joint name="right_steering_joint" type="revolute">
    <parent link="base_link"/>
    <child link="right_steering_link"/>
    <origin xyz="0.25 -0.24 -0.16" rpy="0 0 0"/>
    <axis xyz="0 0 1"/>
    <limit lower="-0.6" upper="0.6" effort="100" velocity="10"/>
  </joint>

  <!-- ======================================================================== -->
  <!-- 3. 轮子 (Wheels) -->
  <!-- 半径 76mm (0.076m), 宽度设为 40mm (0.04m) -->
  <!-- ======================================================================== -->

  <!-- 左前轮 -->
  <link name="left_front_wheel">
    <inertial><mass value="2"/><origin xyz="0 0 0"/><inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.005"/></inertial>
    <visual>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
      <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
    </visual>
    <collision>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
    </collision>
  </link>

  <joint name="left_front_wheel_joint" type="continuous">
    <parent link="left_steering_link"/>
    <child link="left_front_wheel"/>
    <origin xyz="0 0 0" rpy="-1.5707 0 0"/> <!-- 翻转90度让圆柱横过来 -->
    <axis xyz="0 0 1"/> <!-- 这里的轴是相对于翻转后的圆柱 -->
  </joint>

  <!-- 右前轮 -->
  <link name="right_front_wheel">
    <inertial><mass value="2"/><origin xyz="0 0 0"/><inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.005"/></inertial>
    <visual>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
    </collision>
  </link>

  <joint name="right_front_wheel_joint" type="continuous">
    <parent link="right_steering_link"/>
    <child link="right_front_wheel"/>
    <origin xyz="0 0 0" rpy="-1.5707 0 0"/>
    <axis xyz="0 0 1"/>
  </joint>

  <!-- 左后轮 (没有转向节，直接连车身) -->
  <link name="left_rear_wheel">
    <inertial><mass value="2"/><origin xyz="0 0 0"/><inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.005"/></inertial>
    <visual>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
    </collision>
  </link>

  <joint name="left_rear_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="left_rear_wheel"/>
    <origin xyz="-0.25 0.24 -0.16" rpy="-1.5707 0 0"/>
    <axis xyz="0 0 1"/>
  </joint>

  <!-- 右后轮 -->
  <link name="right_rear_wheel">
    <inertial><mass value="2"/><origin xyz="0 0 0"/><inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.005"/></inertial>
    <visual>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><cylinder radius="0.076" length="0.04"/></geometry>
    </collision>
  </link>

  <joint name="right_rear_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="right_rear_wheel"/>
    <origin xyz="-0.25 -0.24 -0.16" rpy="-1.5707 0 0"/>
    <axis xyz="0 0 1"/>
  </joint>


  <!-- ======================================================================== -->
  <!-- 4. 传感器 (Lidar & GPS) -->
  <!-- ======================================================================== -->
  
  <link name="hokuyo_link">
    <visual>
      <geometry><cylinder radius="0.03" length="0.05"/></geometry>
      <material name="blue"><color rgba="0 0 1 1"/></material>
    </visual>
  </link>
  <joint name="hokuyo_joint" type="fixed">
    <parent link="base_link"/>
    <child link="hokuyo_link"/>
    <!-- 放在车头顶部: X靠前, Z在车顶(0.323/2 = 0.1615) + 雷达高度一半 -->
    <origin xyz="0.35 0 0.18" rpy="0 0 0"/>
  </joint>

  <!-- Gazebo 插件: 激光雷达 -->
  <gazebo reference="hokuyo_link">
    <sensor name="lidar" type="ray">
      <always_on>true</always_on>
      <visualize>true</visualize>
      <update_rate>10</update_rate>
      <ray>
        <scan>
          <horizontal>
            <samples>360</samples>
            <resolution>1</resolution>
            <min_angle>-3.14</min_angle>
            <max_angle>3.14</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.12</min>
          <max>10.0</max>
        </range>
      </ray>
      <plugin name="scan" filename="libgazebo_ros_ray_sensor.so">
        <ros><remapping>~/out:=scan</remapping></ros>
        <output_type>sensor_msgs/LaserScan</output_type>
        <frame_name>hokuyo_link</frame_name>
      </plugin>
    </sensor>
    <material>Gazebo/Blue</material>
  </gazebo>


  <!-- ======================================================================== -->
  <!-- 5. 阿克曼驱动插件 -->
  <!-- ======================================================================== -->
  <gazebo>
    <plugin name="gazebo_ros_ackermann_drive" filename="libgazebo_ros_ackermann_drive.so">
      <ros>
        <remapping>cmd_vel:=cmd_vel</remapping>
        <remapping>odom:=odom</remapping>
      </ros>

      <update_rate>100.0</update_rate>

      <!-- 关节定义 -->
      <front_left_joint>left_front_wheel_joint</front_left_joint>
      <front_right_joint>right_front_wheel_joint</front_right_joint>
      <rear_left_joint>left_rear_wheel_joint</rear_left_joint>
      <rear_right_joint>right_rear_wheel_joint</rear_right_joint>
      <left_steering_joint>left_steering_joint</left_steering_joint>
      <right_steering_joint>right_steering_joint</right_steering_joint>

      <!-- 阿克曼几何参数 -->
      <max_steer>0.6</max_steer>
      <max_steering_angle>7.85</max_steering_angle>
      <max_speed>20</max_speed>

      <!-- PID 控制参数 -->
      <left_steering_pid_gain>1000 0 1</left_steering_pid_gain>
      <right_steering_pid_gain>1000 0 1</right_steering_pid_gain>
      <linear_velocity_pid_gain>500 0 1</linear_velocity_pid_gain>

      <!-- 发布里程计 -->
      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf>
      <publish_wheel_tf>true</publish_wheel_tf>
      <publish_distance>true</publish_distance>

      <odometry_frame>odom</odometry_frame>
      <robot_base_frame>base_link</robot_base_frame>
    </plugin>
  </gazebo>

  <!-- Gazebo 颜色美化 -->
  <gazebo reference="base_link">
    <material>Gazebo/White</material>
  </gazebo>
  <gazebo reference="left_front_wheel">
    <material>Gazebo/FlatBlack</material>
  </gazebo>
  <gazebo reference="right_front_wheel">
    <material>Gazebo/FlatBlack</material>
  </gazebo>
  <gazebo reference="left_rear_wheel">
    <material>Gazebo/FlatBlack</material>
  </gazebo>
  <gazebo reference="right_rear_wheel">
    <material>Gazebo/FlatBlack</material>
  </gazebo>

</robot>